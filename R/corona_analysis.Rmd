---
title: "corona_analysis"
output:
  html_document:
    fig_width: 6
    fig_height: 4

knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, 
  encoding=encoding,
  output_file=here::here(out_dir,"index.html")
 )
 })
    
---



```{r setup, include=FALSE}


# publish rmarkdown to github pages: 
#https://resources.github.com/whitepapers/github-and-rstudio/

# file.path(here::dr_here(), out_dir, 'index.html'))})
# file.path(here::dr_here(out_dir, 'index.html'), "docs", 'index.html')
# 
# here::dr_here()

# output: 
#   html_document:
#     keep_md: true
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  rownames.print = 50,
  cols.print = 20,
   fig_width =  6,
  fig_height = 4)

```

```{r, echo=FALSE}
require(pacman)
p_load(tidyverse)
p_load(lubridate)
p_load(magrittr)
p_load(fpp3)
p_load(plotly)
p_load(slider)
p_load(glue)
```

# CONFIG
```{r }

data_sources <-
  list(
    confirmed = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv",
    deaths = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv"
  )


MIN_SAMPLE_SIZE = 14
COUNTRY_STATE_FOR_MODELING <- 
  c(
    "China: Hubei",
    "China: Non-Hubei",
    "France: France",
    "Germany",
    "Iran",
    "Italy",
    "Spain",
    "Korea, South",
    "Netherlands: Netherlands",
    "Norway",
    "Sweden",
    "Switzerland",
    "United Kingdom: United Kingdom",
    "Israel")

FORECASTING_DAYS = 7
```



# load & tidy data
```{r, echo = FALSE, message=FALSE, warning=FALSE}
data <- 
  local({
    
    data_raw <- 
      # localizebase::cache_eval(
      #   keys = Sys.Date(),
      #   expr = 
      #     {
            data_sources %>% 
            map(read_csv)
          # })
    
    data_tidy <- 
      data_raw$confirmed %>%
      select(-c("Lat", "Long")) %>%
      pivot_longer(-c("Province/State", "Country/Region"), "date") %>%
      set_colnames(c("state","country", "date", "confirmed")) %>%
      filter(confirmed>=which.min(confirmed>=1)) %>% 
      mutate(date=as.Date(date, "%m/%d/%y")) 
      # filter(date<="2020-03-22") #debug
    
    df_proc <- 
      data_tidy %>% 
      mutate(state = ifelse((country == "China" & state != "Hubei"),"Non-Hubei", state)) %>% 
      mutate(country_state = paste0(country, ifelse(is.na(state),"",paste0(": ",state)))) %>%
      group_by(country,country_state,date) %>% 
      summarise(confirmed = sum(confirmed)) %>% 
      group_by(country_state) %>%
      mutate(n_country_state_confirmed = sum(confirmed[date == max(date)])) %>%
      ungroup() %>%
      group_by(country_state) %>%
      arrange(date) %>%
      mutate(
        new_cases = confirmed-lag(confirmed),
        r = confirmed/lag(confirmed),
        r = ifelse(is.infinite(r) | is.nan(r) | is.na(r), 1, r)
        # r = ifelse(is.nan(r), NA_real_, r),
      ) %>% 
      mutate(mean_new_cases = slider::slide_dbl(new_cases, mean, .before=3),
             mean_r = slider::slide_dbl(r, mean, .before=1, .after=1)) %>% 
      mutate(
        date_case100 = min(date[confirmed>=100]),
        date_peak = min(date[which.max(mean_r)]),
        date0 = min(date[date >= date_peak +7
                         & date >= date_case100]),
        dateEnd = min(date[date > date0 & mean_new_cases == 0 ]),
        n_row = row_number(),
        min_nday = min(n_row[date == date0]),
        max_nday = max(n_row) - 1,
        is_date0na = is.na(as.POSIXlt(date0)),
        n_day = ifelse(is_date0na, # now day0 found - non of the dates meets the cretiria
                               n_row - max(n_row) - 1,
                               n_row - min(n_row[date == date0]))

       ) %>% 
      ungroup() %>% 
      arrange(country_state, date)
    
    df_clean <- 
      df_proc %>% 
      filter(
        # (n_country_state_confirmed >= 1000 | 
           country_state %in% COUNTRY_STATE_FOR_MODELING) %>% 
      # group_by(country_state) %>% 
      # filter(n()>=MIN_SAMPLE_SIZE) %>% 
      # ungroup() %>% 
      select(country, country_state, n_day, n_country_state_confirmed, date, everything())
    
    res <- 
      list(
        df_proc = df_proc,
        df_clean = df_clean
      )
  })


glue::glue("date range [{min(data$df_proc$date)} - {max(data$df_proc$date)}]")
```


# daily percent change in total confirmed cases:  
# (1) trend extrapolation for next 7 days for top countries, and
# (2) modeling various scenarios for Israel for the next 7 days (e.g. if its confirmed cases dynamic will be similar to Iran or S.Korea).
```{r }
# fit exponentinal smoothing model for region
model_data <- 
  local({
    
    tsbl <-
      data$df_clean %>% 
      mutate(r = ifelse(date == date0, 1, r)) %>% 
      # filter(n_day>=0) %>% 
      as_tsibble(key = c("country","country_state"),
                 index = n_day)
    
    ETS_model_fitted <- 
      tsbl %>% 
      model(ETS(r ~ error("A") + trend("A") + season("N"),  opt_crit = "mae")) 
    # !!rlang::sym(TARGET_VAR)
    
    interpolation <- 
      ETS_model_fitted %>% 
      augment() %>% 
      as_tibble() %>% 
      select(
        country,
        country_state, 
        n_day,
        r_model = .fitted)
    
     extrapolation <- 
       ETS_model_fitted %>% 
       forecast(h = FORECASTING_DAYS) %>%
       as_tibble() %>% 
       select(country,
              country_state, 
              n_day,
              r_model = r)
     
     fitted_data <- 
       bind_rows(interpolation = interpolation,
                 extrapolation = extrapolation,
                 .id = "fit_type") %>% 
       mutate(r_model = pmax(r_model,1))
     
     model_data <- 
       fitted_data %>% 
       full_join(data$df_clean, 
                 by = c("country","country_state", "n_day")) %>% 
       mutate(prc_change_in_total_cases_model = 100*(r_model - 1)) %>%
      group_by(country_state) %>% 
       arrange(date) %>% 
       # fill missing date for extrapulated value 
       mutate(
         date_latest = date[which.max(date)], #only interpulated data has dates after the join
         n_day_latest = max(n_day[which.max(date)]),
         confirmed_latest = max(confirmed[which.max(date)]),
         # confirmed_first = min(confirmed[which.min(date)]),
         date = date_latest + days(n_day-n_day_latest)
         ) %>% # add date to extrapolated values
       ungroup() %>%
       # calc confirmed case by model r for the extrapolated entries
       (function(data){
         extrapolation <-
           data %>%
           filter(fit_type == "extrapolation") %>%
           group_by(country_state) %>%
           arrange(date) %>%
           mutate(
             #confirmed = confirmed_latest,
                  confirmed_model = # calc confirmed cases by r_model
                    Reduce(init = max(confirmed_latest),
                           x = lead(r_model), #lead(r_model),
                           f = prod, 
                           accumulate = T)[-1]
                  # confirmed = NA_integer_
                  ) %>% 
           ungroup() 
         data %>%
           filter(fit_type == "interpolation") %>%
           bind_rows(extrapolation)
        }) %>% 
       select(
         country,
         country_state, 
         date,
         date0, n_day, new_cases, confirmed, confirmed_model,
         r, fit_type, r_model, prc_change_in_total_cases_model, 
         date_peak
       )
  })




```


# Total confirmed cases by day for regions of interest
```{r}
local({
  
  data_for_plot <- 
    model_data %>% 
    group_by(country_state) %>% 
    mutate(n_day = n_day - min(n_day)) %>% 
    ungroup()
  
  plot <- 
    ggplot(data = data_for_plot,
           aes(x = n_day,y = confirmed, color = country_state),
           show.legend = FALSE) +
    geom_point(alpha = 0.4, color = "black", show.legend = FALSE)+
    geom_smooth(se=F, show.legend = FALSE)+
    ggtitle("Total confirmed COVID-19 cases by country") +
    ylab("total confirmed cases") +
    facet_wrap(~country_state, scales = "free") 
  
  suppressWarnings(print(plot))
})
```



# % change in total cases by day 
## (if % change = 20% in a given day ==>  total patients grew by 20% relative to the previous day ).  
## the dashed line show extrapulation 7 days forward.
```{r}
# daily percent change in *total* confirmed cases
local({
  
  data_for_plot <- 
    model_data %>% 
    group_by(country_state) %>% 
    mutate(n_day = n_day - min(n_day)) %>% 
    ungroup()
  
  plot <- 
    ggplot(data = data_for_plot,
           aes(x = n_day,y = 100*(r-1), color = country_state),
           show.legend = FALSE) +
    geom_point(alpha = 0.4, color = "black") +
    geom_line(
      data = data_for_plot %>% filter(fit_type=="interpolation"),
      aes(x=n_day,y=prc_change_in_total_cases_model, color = country_state), 
      show.legend = FALSE,
      alpha = 0.8, size = 1.0) +
    geom_line(
      data = data_for_plot %>% filter(fit_type == "extrapolation"),
      aes(x = n_day,y = prc_change_in_total_cases_model, color = country_state),
      show.legend = FALSE,
      linetype = "dashed"
      ) +
    ggtitle("% change in total cases") +
    # ylim(0, 80) +
    ylab("% change in total cases") +
    facet_wrap(~country_state, scales = "free") 
  
  suppressWarnings(print(plot))
})
```


# forecast scenarios total number of cases for Israel based on Israel itself and other countries such as S.Korea, Italy, Iran
```{r, fig.width=4, fig.height=2}
df_latest_day_IL <- 
  model_data %>% 
  filter(country_state == "Israel", 
         fit_type == "interpolation") %>% 
  top_n(wt = date, n = 1)

print(glue("Israel {df_latest_day_IL$date}: r_model {df_latest_day_IL $r_model}; confirmed cases: {df_latest_day_IL$confirmed} "))

# generate forecast for IL based on each countrty (calc 7 days fwd r_model)
ts_forecast <- 
  model_data %>% 
  filter(country_state != "Israel") %>% 
  filter(date >= date0) %>% 
  group_by(country_state) %>% 
  arrange(date) %>% 
  mutate(
    abs_diff = abs(r_model - df_latest_day_IL$r_model),
    min_diff_date = date[which.min(abs_diff)],
    dateStart = min_diff_date,  #note that this is "today" not a forecasted day
    dateEnd = dateStart + FORECASTING_DAYS) %>% 
  filter(date >= dateStart, date <= dateEnd) %>% 
  filter(abs_diff<=0.1) %>% 
  filter(n() == FORECASTING_DAYS + 1) %>% 
   mutate( # fill mising dates
    date_il = df_latest_day_IL$date + lubridate::days(0:7),
    confirmed_forecast_isr = # predict IL by other cointries
      Reduce(init = df_latest_day_IL$confirmed,
             x = lead(r_model), 
             f = prod, accumulate = T) %>% head(-1)
    ) %>% 
  # mutate(r_model_il = confirmed_forecast_isr/lag(confirmed_forecast_isr),
  #        prc_change_in_total_cases_model_il = 100*(r_model_il-1)) %>%  # recalc according to the confirmed forecast_isr
  ungroup() %>% 
  arrange(country_state, date) %>% 
  select(country_state, date, dateStart, dateEnd,
         r_model, prc_change_in_total_cases_model, date_il, confirmed_forecast_isr)

ts_forecast_with_il <- 
  ts_forecast %>% 
  # select(country_state, date, dateStart, dateEnd, date_il, prc_change_in_total_cases_model, confirmed_forecast_isr) %>% 
  bind_rows(model_data %>% 
              filter(country_state == "Israel") %>% 
              select(country_state, 
                     date,
                     date_il = date, 
                     prc_change_in_total_cases_model,
                     confirmed_forecast_isr = confirmed_model)
  ) %>% 
  select(country_state, date,dateStart, dateEnd, prc_change_in_total_cases_model, 
         date_il, confirmed_forecast_isr)
         #,r_model_il, prc_change_in_total_cases_model_il)



# layers: (1) regions raw data points (2) interpulation of raw points + (3) extrapulation (dashed line) + (4) fat lines for date-interval (7 days) used to predict IL
local({
  plot <- 
    ggplot(model_data %>% semi_join(ts_forecast_with_il, "country_state") %>% 
             filter(country_state != "Israel",fit_type == "interpolation"),
           aes(x = date,y = prc_change_in_total_cases_model, color = country_state),
           show.legend = FALSE) +
    geom_point(alpha = 0.1, color = "black") + # raw data
    geom_line( # smooting of raw data
      show.legend = FALSE,
      alpha = 0.5, size = 0.9) +
    geom_line( #forecast of raw
      data = model_data %>% semi_join(ts_forecast_with_il, "country_state") %>% 
        filter(country_state != "Israel", fit_type == "extrapolation"),
      show.legend = FALSE,
      linetype = "dashed"
      ) +
    geom_vline(data = ts_forecast_with_il %>% filter(country_state != "Israel"), 
               aes(xintercept = dateStart))+
    geom_vline(data = ts_forecast_with_il %>% filter(country_state != "Israel"), 
               aes(xintercept = dateEnd))+
    ggtitle("date range selected for forecasting of IL by ref. country ") +
    ylim(0, 70) +
    ylab("% change in total cases") +
    # scale_x_date(date_breaks = "3 weeks", date_labels =  "%d-%b") +
    facet_wrap(~country_state, scales = "free") 
  
  suppressWarnings(print(plot))
})
```


# forecast IL total cases over time by ref. regions
```{r}

local({

  plot <-  
    ggplot(
      data = 
        model_data %>% 
        filter(country_state == "Israel", fit_type == "interpolation"),
      mapping = aes(x = date, y = confirmed, color = country_state),
      show.legend = FALSE) +
    geom_point(alpha = 0.3, 
               color = "black") + # raw data
    geom_smooth(se=F, method = "gam") +
    geom_line(# smooting of raw data
      data = model_data %>% 
                 filter(country_state == "Israel", fit_type == "extrapolation"),
      mapping = aes(x = date, y = confirmed_model),
       alpha = 0.5, size = 0.9,
      linetype = "dashed"
      )  +
    geom_line(
      data = ts_forecast_with_il, #%>% filter(country_state != "Israel"),
      aes(x = date_il, y = confirmed_forecast_isr, color = country_state),
      linetype = "dashed",
      size = 1
    ) +
    ggtitle("Israel - total confirmed cases forecasting 7 days fwd by ref. countries") +
    ylab("total confirmed cases") 
  
  suppressWarnings(print(plot))
})
```



# IL total cases over time (with 7 days extrapulation) + prediction base on ref. countries.
```{r}

local({
  
  plot <- 
    ggplot(model_data %>% 
             filter(country_state == "Israel", fit_type == "interpolation"),
           aes(x = date,y = prc_change_in_total_cases_model),
           show.legend = FALSE) +
    geom_line( # smooting of raw data
      show.legend = FALSE,
      alpha = 0.5, size = 0.9) +
    geom_point(data = model_data %>% filter(country_state == "Israel", fit_type == "interpolation"),
              alpha = 0.3, color = "black") + # raw data
    geom_line( # data used for IL prediction
      data = ts_forecast_with_il, #%>% filter(country_state != "Israel"),
      aes(x = date_il, y = prc_change_in_total_cases_model, color = country_state),
      linetype = "dashed",
      size = 1
    ) +
    ggtitle("Israel - forecasting of daily change in *total confirmed cases* by ref. countries") +
    ylim(0, 100) +
    ylab("% change in total cases") 
  
  suppressWarnings(print(plot))
})
```



 
  ```{r}
  

# forecast_by_country_state <- 
#   unique(tsbl$country_state) %>% 
#   purrr::set_names() %>% 
#   map(function(country_state){
#     data_ts <- tsbl %>% filter(country_state == !!country_state)
#     # data_model <- fit %>% filter(country_state == !!country_state)
#     
#     data_ts %>% 
#       autoplot(r) +
#       geom_line(data = augment(fit),linetype = "dashed") +
#       ggtitle(country_state)
#   }
#   )



# fitted_models <- 
#   list(
#     naive_models =
#       model(ts_train,
#             Naive = NAIVE(!!rlang::sym(TARGET_VAR)),
#             Drift = RW(!!rlang::sym(TARGET_VAR) ~ drift())
#       ),
#     advanced_models =
#       model(ts_train,
#             Seasonal_naive = SNAIVE(!!rlang::sym(TARGET_VAR)),
#             ETS = ETS(!!rlang::sym(TARGET_VAR)),
#             ARIMA = ARIMA(!!rlang::sym(TARGET_VAR)),
#       ))


# forecasting <- 
#   fitted_models %>% 
#   map(
#     
#     
#   )
#   



# features: y, (y-1)/(lag(y)-1), 1+mean(x-1)
# 






# fitted_models$advanced_models %>% 
#   forecast(h = FORECASTING_DAYS) %>% 
#   autoplot(!!rlang::sym(TARGET_VAR))
# 
# 
# 
# # model with benchmark vs advanced models
# fitted_models %>% 
#   map(function(models){
#     models %>% 
#       forecast(.,h = FORECASTING_DAYS) %>% 
#       autoplot(ts) 
#       # xlab("Year") + ylab("Megalitres") +
#       # ggtitle("Forecasts for quarterly beer production") +
#       # guides(colour=guide_legend(title="Forecast"))
#   })


```


```{r}
# all time - by date
data$df_proc %>% 
  semi_join(data$df_clean, by = "country_state") %>% 
  ggplot(aes(date, y = confirmed, color = country_state)) + #  need to specify only the target var
  geom_point(alpha = 0.3) +
  geom_smooth(se=F,method = "gam")+
  ggtitle("Total confirmed COVID-19 cases by country-state") +
  ylab("total confirmed cases") + 
  xlab("date")

# since stable point 
(
  data$df_clean %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), y = confirmed, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3)+
    geom_smooth(se=F,method = "gam")+
    ggtitle("Total confirmed COVID-19 cases by country-state") +
    ylab("total confirmed cases") +
     xlab("day")
 ) %>%  ggplotly()

# since first confirmed
(
  data$df_proc %>% 
    semi_join(data$df_clean, by = "country_state") %>% 
    filter_verbose(confirmed>=1) %>%
    group_by(country_state) %>% 
    arrange(country_state, date) %>% 
    mutate(n_day = row_number()) %>% 
    ungroup() %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), y = log(confirmed), color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3)+
    geom_smooth(se=F)+
    ylab("total confirmed cases") + 
    xlab("days (since first confirmed case)") +
    # ylim(0,7e4)+
    ggtitle("total confirmed cases")
) %>% ggplotly()




# new cases since confirmed cases > 30
(
  data$df_proc %>% 
    semi_join(data$df_clean, by = "country_state") %>% 
    filter_verbose(confirmed>=30) %>%
    group_by(country_state) %>%
    arrange(country_state, date) %>%
    mutate(n_day = row_number(),
           latest_r = r[which.max(date)]
           ) %>%
    ungroup() %>%
    arrange(latest_r) %>% 
    ggplot(aes(n_day, y = new_cases, color = country_state)) + #  need to specify only the target var
    geom_bar(stat="identity") +
    geom_smooth(se=F, method ="gam") +
    # ylim(0,5e3)+
    facet_wrap(vars(country_state), scales = "free") +
    ggtitle("new cases by day") +
    ylab("new cases") + 
    xlab("days") 
) %>% ggplotly()





# R by date
(
  data$df_proc %>% 
    semi_join(data$df_clean, by = "country_state") %>% 
    # filter_verbose(confirmed>=1) %>%
    group_by(country_state) %>% 
    arrange(country_state, date) %>% 
    mutate(n_day = row_number()) %>% 
    ungroup() %>% 
    ggplot(aes(date, r, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3) +
    # geom_smooth(se=F) +
    geom_smooth(se=F, method ="gam", formula = y ~ s(x, bs = "cs",k=4)) +
    facet_wrap(vars(country_state), scales = "free_x") +
    ggtitle("daily growth rates R (R = total cases in day i / total cases in day i-1)", 
            subtitle = "if R = 1 ==> NO NEW CASES")+
    ylab("R") +
    ylim(1,1.75)+
    xlab("date") 
) %>% 
  ggplotly()




# R since day 0
(
  tsbl %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), r, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.5) +
    # geom_smooth(se=F) +
    geom_smooth(se=F, method ="gam", formula = y ~ s(x, bs = "cs",k=4)) +
    facet_wrap(vars(country_state), scales = "free_x") +
    ggtitle("growth rates R (R = total cases in day i / total cases in day i-1)")+
    ylab("R") +
    ylim(1,1.75)+
    xlab("date") 
) %>% 
  ggplotly()



(
  tsbl %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), r, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3) +
    geom_smooth(se=F)+
    ylab("R") + 
    xlab("day") +
    ggtitle("R by day")
)%>%  ggplotly()





# log R
(tsbl %>% 
    ggplot(aes(date, log(r), color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3) +
    geom_smooth(se = F)+
    ylab("log(R)") + 
    xlab("date") +
    ggtitle("log(R) by day"))%>% 
  ggplotly()

```


