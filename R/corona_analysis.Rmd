---
title: "corona_analysis"

knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=here::here(out_dir,"index.html")
 )
 })
    
---



```{r setup, include=FALSE}

# publish rmarkdown to github pages: 
#https://resources.github.com/whitepapers/github-and-rstudio/

# file.path(here::dr_here(), out_dir, 'index.html'))})
# file.path(here::dr_here(out_dir, 'index.html'), "docs", 'index.html')
# 
# here::dr_here()

# output: 
#   html_document:
#     keep_md: true
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
require(pacman)
p_load(tidyverse)
p_load(magrittr)
p_load(fpp3)
p_load(plotly)
library(localizebase)
```

# CONFIG
```{r }

data_sources <- 
  list(
    confirmed = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv",
    deaths = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv"
  )


MIN_SAMPLE_SIZE = 14
COUNTRY_STATE_FOR_MODELING <- 
  c(
    "China: Hubei",
    "China: Non-Hubei",
    "France: France",
    "Germany",
    "Iran",
    "Italy",
    "Spain",
    "Korea, South",
    "Netherlands: Netherlands",
    "Norway",
    "Sweden",
    "Switzerland",
    "United Kingdom: United Kingdom",
    "Israel")

FORECASTING_DAYS = 7
```



# load & tidy data
```{r, echo = FALSE, message=FALSE, warning=FALSE}
data <- 
  local({
    
    data_raw <- 
      localizebase::cache_eval(
        keys = Sys.Date(),
        expr = 
          {
            data_sources %>% 
            map(read_csv)
          })
    
    data_tidy <- 
      data_raw$confirmed %>%
      select(-c("Lat", "Long")) %>%
      pivot_longer(-c("Province/State", "Country/Region"), "date") %>%
      set_colnames(c("state","country", "date", "confirmed")) %>%
      filter(confirmed>=which.min(confirmed>=1)) %>% 
      mutate(date=as.Date(date, "%m/%d/%y")) 
    
    df_proc <- 
      data_tidy %>% 
      mutate(state = ifelse((country == "China" & state != "Hubei"),"Non-Hubei", state)) %>% 
      mutate(country_state = paste0(country, ifelse(is.na(state),"",paste0(": ",state)))) %>%
      group_by(country,country_state,date) %>% 
      summarise(confirmed = sum(confirmed)) %>% 
      group_by(country_state) %>%
      mutate(n_country_state_confirmed = sum(confirmed[date == max(date)])) %>%
      ungroup() %>%
      group_by(country_state) %>%
      arrange(date) %>%
      mutate(
        new_cases = confirmed-lag(confirmed),
        r = confirmed/lag(confirmed),
        r = ifelse(is.infinite(r) | is.nan(r) | is.na(r), 1, r)
        # r = ifelse(is.nan(r), NA_real_, r),
      ) %>% 
      mutate(mean_new_cases = slider::slide_dbl(new_cases, mean, .before=3),
             mean_r = slider::slide_dbl(r, mean, .before=1, .after=1)) %>% 
      mutate(
        date_case100 = min(date[confirmed>=100]),
        date_peak = min(date[which.max(mean_r)]),
        date0 = min(date[date >= date_peak 
                         #& date >= date_case100
                         ]),
        dateEnd = min(date[date > date0 & mean_new_cases == 0 ]),
        n_row = row_number(),
        min_nday = min(n_row[date == date0]),
        max_nday = max(n_row) - 1,
        is_date0na = is.na(as.POSIXlt(date0)),
        n_day = ifelse(is_date0na, 
                               n_row - max(n_row) - 1,
                               n_row - min(n_row[date == date0]))

       ) %>% 
      ungroup() %>% 
      arrange(country_state, date)
    
    df_clean <- 
      df_proc %>% 
      filter_verbose(
        # (n_country_state_confirmed >= 1000 | 
           country %in% COUNTRY_STATE_FOR_MODELING) %>% 
      # group_by(country_state) %>% 
      # filter(n()>=MIN_SAMPLE_SIZE) %>% 
      # ungroup() %>% 
      select(country, country_state, n_day, n_country_state_confirmed, date, everything())
    
    res <- 
      list(
        df_proc = df_proc,
        df_clean = df_clean
      )
  })


glue::glue("date range [{min(data$df_proc$date)} - {max(data$df_proc$date)}]")
```


# daily percent change in total confirmed cases -  
# (1) trend extrapolation for next 7 days for top countries + 
# (2) model various scenarios for Israel for the next 7 days (e.g. if it will act like Iran or S.Korea)
```{r }

DATE_INDEX_COL = "n_day" # "date
TARGET_VAR = "r"

# fit exponentinal smoothing model for region
model_data <- 
  local({
    
    tsbl <-
      data$df_clean %>% 
      mutate(r = ifelse(date == date0, 1, r)) %>% 
      # filter(n_day>=0) %>% 
      as_tsibble(key = country_state,
                 index = DATE_INDEX_COL)
    
    ETS_model_fitted <- 
      tsbl %>% 
      # filter(country=="Austria") %>% 
      model(ETS(r ~ error("A") + trend("A") + season("N"),  opt_crit = "mae")) 
    # !!rlang::sym(TARGET_VAR)
    
    interpolation <- 
      ETS_model_fitted %>% 
      augment() %>% 
      as_tibble() %>% 
      select(country_state, n_day,
             r_model = .fitted)
     extrapolation <- 
       ETS_model_fitted %>% 
       forecast(h = FORECASTING_DAYS) %>% 
       as_tibble() %>% 
       select(country_state, n_day,
              r_model = r)
     
     fitted_data <- 
       bind_rows(interpolation = interpolation,
                 extrapolation = extrapolation,
                 .id = "fit_type") %>% 
       mutate(r_model = pmax(r_model,1))
     
     model_data <- 
       fitted_data %>% 
       full_join(data$df_clean) %>% 
       mutate(prc_change_in_total_cases = 100*(r_model - 1))
  })

data$df_clean %>% 
  ggplot(aes(x=n_day,y=r, color = country_state)) +
  geom_point(alpha = 0.2) +
  geom_smooth()+
  ggtitle("% change in total cases by day",subtitle = "Day 0 - is the first day with after the data is stabilized") +
  ylim(0,.6) +
  ylab("% change in total cases") +
  facet_wrap(vars(country_state), scales = "free_x") 



```


# daily % change (r = 1 - number total cases stays the same; r > 1 proportional to growth rate, e.g. if in day i r=1.2 it means that the number of total patients grew by 20% relative to the day i - 1 ). the dashed line show extrapulation 7 days forward.
# Day 0 - the first day since the peak in r when total number of patients > 100 and 

```{r}
# daily percent change in *total* confirmed cases
local({
  
  data_for_plot <- 
    model_data %>% 
    group_by(country_state) %>% 
    mutate(n_day = n_day - min(n_day)) %>% 
    ungroup()
  
  plot <- 
    ggplot(data = data_for_plot,
           aes(x = n_day,y = 100*(r-1), color = country_state)) +
    geom_point(alpha = 0.4, color = "black") +
    geom_line(
      data = data_for_plot %>% filter(fit_type=="interpolation"),
      aes(x=n_day,y=prc_change_in_total_cases, color = country_state),
      alpha = 0.8, size = 1.0) +
    geom_line(
      data = data_for_plot %>% filter(fit_type == "extrapolation"),
      aes(x = n_day,y = prc_change_in_total_cases, color = country_state),
      linetype = "dashed") +
    ggtitle("% change in total cases") +
    ylim(0, 70) +
    ylab("% change in total cases") +
    facet_wrap(~country_state, scales = "free") 
  
  suppressWarnings(print(plot))
})
```



```{r}

# for each <geo,time> calc 7 days fwd r coefs (based on fitted Rs)  
ts_forecast <- 
  tsbl %>% 
  full_join(augment(ETS_fitted) %>% select(country_state ,n_day, r_fitted),
            by = c("country_state", "n_day")) %>% 
  mutate(r_lead7_prod = slide_dbl(lead(r_fitted, 1), prod, .size=7, .align="left"))
  


### FOCAST CASES FOR A GIVEN COUNTRY

#INPUT - 
R_FORECAST <- 1.1743536


r7coef_by_country_state <- 
  ts_forecast %>% 
  group_by(country_state) %>% 
  mutate(
    # r_closet_vs_fitted_abs_diff = abs(.fitted-R_FORECAST),
    r_closet_vs_fitted_prc_diff = 100*abs(.fitted-R_FORECAST)/R_FORECAST,
    is_r_closest = .fitted == min(.fitted[which.min(r_closet_vs_fitted_prc_diff)])
    ) %>% 
  ungroup() %>% 
  filter(is_r_closest, 
         r_closet_vs_fitted_prc_diff <= 5) %>% 
  arrange(r_lead7_prod) %>% 
  as_tibble() %>% 
  select(country_state, 
         r7coef = r_lead7_prod)
  
# QA
z <- 
  ts_forecast %>% 
  filter(country_state == "China: Hubei") %>% 
  left_join(r7coef_by_country_state,
            by = "country_state") %>% 
  mutate(confirmed_fc7 = confirmed*r7coef) %>% 
  select(country,country_state, date, n_day, confirmed, r, .fitted, r_lead7_prod, r7coef, confirmed_fc7)
  

  
  

# forecast_by_country_state <- 
#   unique(tsbl$country_state) %>% 
#   purrr::set_names() %>% 
#   map(function(country_state){
#     data_ts <- tsbl %>% filter(country_state == !!country_state)
#     # data_model <- fit %>% filter(country_state == !!country_state)
#     
#     data_ts %>% 
#       autoplot(r) +
#       geom_line(data = augment(fit),linetype = "dashed") +
#       ggtitle(country_state)
#   }
#   )



# fitted_models <- 
#   list(
#     naive_models =
#       model(ts_train,
#             Naive = NAIVE(!!rlang::sym(TARGET_VAR)),
#             Drift = RW(!!rlang::sym(TARGET_VAR) ~ drift())
#       ),
#     advanced_models =
#       model(ts_train,
#             Seasonal_naive = SNAIVE(!!rlang::sym(TARGET_VAR)),
#             ETS = ETS(!!rlang::sym(TARGET_VAR)),
#             ARIMA = ARIMA(!!rlang::sym(TARGET_VAR)),
#       ))


# forecasting <- 
#   fitted_models %>% 
#   map(
#     
#     
#   )
#   



# features: y, (y-1)/(lag(y)-1), 1+mean(x-1)
# 






# fitted_models$advanced_models %>% 
#   forecast(h = FORECASTING_DAYS) %>% 
#   autoplot(!!rlang::sym(TARGET_VAR))
# 
# 
# 
# # model with benchmark vs advanced models
# fitted_models %>% 
#   map(function(models){
#     models %>% 
#       forecast(.,h = FORECASTING_DAYS) %>% 
#       autoplot(ts) 
#       # xlab("Year") + ylab("Megalitres") +
#       # ggtitle("Forecasts for quarterly beer production") +
#       # guides(colour=guide_legend(title="Forecast"))
#   })


```


```{r}
# all time - by date
data$df_proc %>% 
  semi_join(data$df_clean, by = "country_state") %>% 
  ggplot(aes(date, y = confirmed, color = country_state)) + #  need to specify only the target var
  geom_point(alpha = 0.3) +
  geom_smooth(se=F,method = "gam")+
  ggtitle("Total confirmed COVID-19 cases by country-state") +
  ylab("total confirmed cases") + 
  xlab("date")

# since stable point 
(
  data$df_clean %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), y = confirmed, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3)+
    geom_smooth(se=F,method = "gam")+
    ggtitle("Total confirmed COVID-19 cases by country-state") +
    ylab("total confirmed cases") +
     xlab("day")
 ) %>%  ggplotly()

# since first confirmed
(
  data$df_proc %>% 
    semi_join(data$df_clean, by = "country_state") %>% 
    filter_verbose(confirmed>=1) %>%
    group_by(country_state) %>% 
    arrange(country_state, date) %>% 
    mutate(n_day = row_number()) %>% 
    ungroup() %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), y = log(confirmed), color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3)+
    geom_smooth(se=F)+
    ylab("total confirmed cases") + 
    xlab("days (since first confirmed case)") +
    # ylim(0,7e4)+
    ggtitle("total confirmed cases")
) %>% ggplotly()




# new cases since confirmed cases > 30
(
  data$df_proc %>% 
    semi_join(data$df_clean, by = "country_state") %>% 
    filter_verbose(confirmed>=30) %>%
    group_by(country_state) %>%
    arrange(country_state, date) %>%
    mutate(n_day = row_number(),
           latest_r = r[which.max(date)]
           ) %>%
    ungroup() %>%
    arrange(latest_r) %>% 
    ggplot(aes(n_day, y = new_cases, color = country_state)) + #  need to specify only the target var
    geom_bar(stat="identity") +
    geom_smooth(se=F, method ="gam") +
    # ylim(0,5e3)+
    facet_wrap(vars(country_state), scales = "free") +
    ggtitle("new cases by day") +
    ylab("new cases") + 
    xlab("days") 
) %>% ggplotly()





# R by date
(
  data$df_proc %>% 
    semi_join(data$df_clean, by = "country_state") %>% 
    # filter_verbose(confirmed>=1) %>%
    group_by(country_state) %>% 
    arrange(country_state, date) %>% 
    mutate(n_day = row_number()) %>% 
    ungroup() %>% 
    ggplot(aes(date, r, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3) +
    # geom_smooth(se=F) +
    geom_smooth(se=F, method ="gam", formula = y ~ s(x, bs = "cs",k=4)) +
    facet_wrap(vars(country_state), scales = "free_x") +
    ggtitle("daily growth rates R (R = total cases in day i / total cases in day i-1)", 
            subtitle = "if R = 1 ==> NO NEW CASES")+
    ylab("R") +
    ylim(1,1.75)+
    xlab("date") 
) %>% 
  ggplotly()




# R since day 0
(
  tsbl %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), r, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.5) +
    # geom_smooth(se=F) +
    geom_smooth(se=F, method ="gam", formula = y ~ s(x, bs = "cs",k=4)) +
    facet_wrap(vars(country_state), scales = "free_x") +
    ggtitle("growth rates R (R = total cases in day i / total cases in day i-1)")+
    ylab("R") +
    ylim(1,1.75)+
    xlab("date") 
) %>% 
  ggplotly()



(
  tsbl %>% 
    ggplot(aes(!!rlang::sym(DATE_INDEX_COL), r, color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3) +
    geom_smooth(se=F)+
    ylab("R") + 
    xlab("day") +
    ggtitle("R by day")
)%>%  ggplotly()





# log R
(tsbl %>% 
    ggplot(aes(date, log(r), color = country_state)) + #  need to specify only the target var
    geom_point(alpha = 0.3) +
    geom_smooth(se = F)+
    ylab("log(R)") + 
    xlab("date") +
    ggtitle("log(R) by day"))%>% 
  ggplotly()

```


